/*!
*  Block position tracking plugin
* 
*  @version 3.0.0
*  @package https://github.com/sosie-js/block-plugin
*/
class BlockPlugin{constructor(){}initScrollToBlock(t){function e(){return function(t){return t.firstChild.firstChild.children}(window.document.getElementById("editorjs"))}t.blocks.scrollToBlock=function(t,o){var n=e();t<n.length&&(n[t].scrollIntoView(!0),window.scrollBy(0,-o))},window.gotoBlockPosition=function(){let e=prompt("Go to position","1");var o="Invalid position"+e+", it must be in integer from 1 to "+t.blocks.getBlocksCount();try{var n,i=parseInt(e);i>0?(n=i-1,t.blocks.scrollToBlock(n,0),setCurrentPosition(i),refreshTotalBlocks()):alert(o)}catch(t){alert("gotoBlockPosition error:"+t)}}}initGetBlockNodeList(t){t.getBlocksNodeList=function(){return document.querySelectorAll(".codex-editor__redactor")[0].childNodes}}getPosition(t){var e=this.editor.getBlocksNodeList(),o=Array.prototype.indexOf.call(e,t);return null==o?"?":o+1}initBlocksPositionListeners(t){var e=this,o=t.clipboard.blockSelection,n=function(o){var n=e.getPosition(this);if(setCurrentPosition(n),refreshTotalBlocks(),"?"!=n){var i=r[n-1].getBoundingClientRect();console.log("Broadcast in instance to be sent from block-plugin"),t.broadcast.postMessage({action:"sync",index:n-1,data:{y:i.top}})}};var i=function(t){o.start=e.getPosition(this),o.end="?"},s=function(t){var n=e.getPosition(this);if(o.start==n){var i=window.getSelection();i.rangeCount>0&&""!=i.getRangeAt(0)&&(o.end=n)}else o.end=n;let s=e.getSelectionCharacterOffsetWithin(t.target);o.in=s.in,o.out=s.out,console.log(o)};t.blocks.addBlockPositionListeners=function(t){t.addEventListener("click",n),t.addEventListener("mousedown",i),t.addEventListener("mouseup",s),console.info("Position Listeners added on block ",t.dataset.blockId)},t.blocks.delBlockPositionListeners=function(t){t.removeEventListener("click",n),t.removeEventListener("mousedown",i),t.removeEventListener("mouseup",s),console.info("Position Listeners removed on block",t.dataset.blockId)};var r=t.getBlocksNodeList();!function(e){for(var o=0,n=e.length;o<n;o++)t.blocks.addBlockPositionListeners(e[o]);t.on("keypress",(function(t){27==t.keyCode&&setCurrentPosition("")}))}(r),
//!NOTE requires the editorjs-Undo with BigBrother patch to work
document.addEventListener("changeBlocks",(function(o){o.detail.changed.forEach(o=>{console.log("changeBlocks",o);var n,i,s=o.blockElement,r=e.getPosition(s)-1,l=s.dataset.blockId;switch(o.changeType){case"add":console.log("Block ("+l+") added at",r),t.blocks.addBlockPositionListeners(s),n=r,i=l,t.broadcast.postMessage({action:"insert",index:n,data:{id:i}});break;case"remove":console.log("Block ("+l+") removed at ",r),t.blocks.delBlockPositionListeners(s),function(e,o){t.broadcast.postMessage({action:"remove",index:e,data:{id:o}})}(r,l);break;case"update":default:"attributes"==o.mutType?(console.log("Block ("+l+") attributes updated at",r),function(e,o){t.broadcast.postMessage({action:"replace",index:e,data:{id:o}})}(r,l)):(console.log("Block ("+l+") updated at",r),function(e,o){t.broadcast.postMessage({action:"edit",index:e,data:{id:o}})}(r,l))}})}))}initClipboard(t){t.clipboard=new function(){this.blockSelection={start:"?",end:"?"},this.data={},this.clear=function(){return this.data={indexes:[],blocks:[]},this.data},this.clear()}}initBlockStatutPositionPanel(t){window.setCurrentPosition=function(t,e){console.info("setCurrentPosition "+t+" from "+e),document.getElementById("currentPosition").value=t},window.refreshCurrentPosition=function(e){var o=t.blocks.getCurrentBlockIndex()+1;setCurrentPosition(o,e||"refreshCurrentPosition")},window.refreshTotalBlocks=function(){document.getElementById("totalBlocks").value=t.blocks.getBlocksCount()},window.refreshBlocksStatusPanel=function(t){refreshCurrentPosition(t||"refreshBlocksStatusPanel"),refreshTotalBlocks()},this.initScrollToBlock(t)}initCaretManager(t){this.setCaretPosition=function(e,o){!function t(e,o){for(var n of e.childNodes)if(3==n.nodeType){if(n.length>=o){var i=document.createRange(),s=window.getSelection();return i.setStart(n,o),i.collapse(!0),s.removeAllRanges(),s.addRange(i),-1}o-=n.length}else if(-1==(o=t(n,o)))return-1;return o}(t.getBlocksNodeList()[e],o)},this.getSelectionCharacterOffsetWithin=function(t){var e,o=0,n=0,i=t.ownerDocument||t.document,s=i.defaultView||i.parentWindow;if(void 0!==s.getSelection){if((e=s.getSelection()).rangeCount>0){var r=s.getSelection().getRangeAt(0),l=r.cloneRange();l.selectNodeContents(t),l.setEnd(r.startContainer,r.startOffset),o=l.toString().length,l.setEnd(r.endContainer,r.endOffset),n=l.toString().length}}else if((e=i.selection)&&"Control"!=e.type){var c=e.createRange(),a=i.body.createTextRange();a.moveToElementText(t),a.setEndPoint("EndToStart",c),o=a.text.length,a.setEndPoint("EndToEnd",c),n=a.text.length}return{in:o,out:n}},this.inlineInjector=function(t){var e,o;window.getSelection&&(e=window.getSelection()).rangeCount?((o=e.getRangeAt(0)).collapse(!0),o.insertNode(t),o.setStartAfter(t),o.collapse(!0),e.removeAllRanges(),e.addRange(o),console.log("Block now injected inline")):alert("Specify first a position with the caret by clicking inside a block")}}init(t){this.editor=t,this.initClipboard(t),this.initGetBlockNodeList(t),this.initBlockStatutPositionPanel(t),this.initBlocksPositionListeners(t),this.initCaretManager(t),console.info("Block plugin initialized")}}window.Block=new BlockPlugin,SoSIE.register("Block");